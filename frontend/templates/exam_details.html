{% extends "base.html" %}

{% block title %}{{ stats.subject_name }} - Exam Details - Answer Sheet Evaluation System{% endblock %}

{% block content %}
<div class="exam-details-container">
    <div class="header">
        <a href="{{ url_for('manage_exams') }}" class="back-link">‚Üê Back to Manage Exams</a>
        <h1>üìö {{ stats.subject_name }}</h1>
        <p class="exam-id">Exam ID: <code>{{ stats.exam_id[:12] }}...</code></p>
    </div>
    
    <!-- Schema PDF Viewer -->
    <div class="schema-viewer-section">
        <h2>üìã Marking Scheme</h2>
        <div class="schema-layout">
            <div class="schema-viewer-container">
                <div class="schema-viewer-header">
                    <h3>üìÑ Schema PDF</h3>
                </div>
                <div id="schemaViewer" class="schema-viewer-box">
                    <p class="loading-message">Loading marking scheme...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card total">
            <div class="stat-icon">üë•</div>
            <div class="stat-content">
                <h3>Total Students</h3>
                <p class="stat-number">{{ stats.total_students }}</p>
            </div>
        </div>
        
        <div class="stat-card evaluated">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
                <h3>Evaluated</h3>
                <p class="stat-number">{{ stats.evaluated_count }}</p>
                {% if stats.total_students > 0 %}
                    <p class="stat-percentage">{{ ((stats.evaluated_count / stats.total_students) * 100)|int }}% complete</p>
                {% else %}
                    <p class="stat-percentage">No students yet</p>
                {% endif %}
            </div>
        </div>
        
        <div class="stat-card pending">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-content">
                <h3>Pending</h3>
                <p class="stat-number">{{ stats.unevaluated_count }}</p>
            </div>
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-section">
        <div class="progress-label">
            <span>Evaluation Progress</span>
            <span class="progress-text">{{ stats.evaluated_count }}/{{ stats.total_students }}</span>
        </div>
        <div class="progress-bar">
            {% if stats.total_students > 0 %}
                <div class="progress-fill" style="width: {{ ((stats.evaluated_count / stats.total_students) * 100)|int }}%">
                    <span class="progress-text-bar">{{ ((stats.evaluated_count / stats.total_students) * 100)|int }}%</span>
                </div>
            {% else %}
                <div class="progress-fill" style="width: 0%">
                    <span class="progress-text-bar">No data</span>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Unevaluated Students List -->
    {% if stats.total_students == 0 %}
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è No students yet</strong>
            <p>No student answer scripts have been uploaded for this exam yet. Upload scripts to see students here.</p>
            <a href="{{ url_for('upload_script') }}" class="btn btn-primary">Upload Scripts</a>
        </div>
    {% elif stats.unevaluated_count > 0 %}
        <div class="students-section">
            <h2>üìã Pending Evaluation ({{ stats.unevaluated_count }} students)</h2>
            
            <form id="evaluationForm">
                <div class="controls">
                    <button type="button" id="selectAll" class="btn btn-secondary">Select All</button>
                    <button type="button" id="deselectAll" class="btn btn-secondary">Deselect All</button>
                    <button type="submit" class="btn btn-primary" id="evaluateBtn">Evaluate Selected</button>
                </div>
                
                <div class="students-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="selectAllCheckbox">
                                </th>
                                <th>Student ID</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student_id in stats.unevaluated_students %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="student_ids" value="{{ student_id }}" class="student-checkbox">
                                    </td>
                                    <td class="student-id">{{ student_id }}</td>
                                    <td class="status">
                                        <span class="badge badge-pending">Pending</span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
            
            <div id="evaluationStatus"></div>
        </div>
    {% else %}
        <div class="alert alert-success">
            <strong>‚úÖ All students evaluated!</strong>
            <p>All {{ stats.total_students }} students have been evaluated for this exam.</p>
        </div>
    {% endif %}
    
    <!-- Evaluated Students Summary -->
    {% if stats.evaluated_count > 0 %}
        <div class="evaluated-section">
            <h2>‚úÖ Completed Evaluations ({{ stats.evaluated_count }} students)</h2>
            
            <div class="evaluated-table">
                <table>
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Score</th>
                            <th>Percentage</th>
                            <th>Questions</th>
                            <th>Last Evaluated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in stats.evaluated_students %}
                            <tr>
                                <td class="student-id">{{ student.student_id }}</td>
                                <td class="score">
                                    <strong>{{ student.total_scored }}/{{ student.total_max }}</strong>
                                </td>
                                <td>
                                    <div class="percentage-badge" style="background: 
                                        {% if student.percentage >= 80 %}#d4edda
                                        {% elif student.percentage >= 60 %}#fff3cd
                                        {% else %}#f8d7da
                                        {% endif %}">
                                        {{ student.percentage }}%
                                    </div>
                                </td>
                                <td class="text-center">{{ student.question_count }}</td>
                                <td class="date">{{ student.generated_at }}</td>
                                <td class="actions">
                                    <a href="{{ url_for('results', exam_id=stats.exam_id, student_id=student.student_id) }}" class="btn btn-sm btn-primary" title="View detailed results">View</a>
                                    <button onclick="reEvaluateStudent('{{ stats.exam_id }}', '{{ student.student_id }}')" class="btn btn-sm btn-warning" title="Re-evaluate to update scores">Re-evaluate</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div id="reEvaluateStatus"></div>
        </div>
    {% endif %}
</div>

<style>
    .exam-details-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .header {
        margin-bottom: 30px;
    }
    
    .back-link {
        display: inline-block;
        color: #667eea;
        text-decoration: none;
        margin-bottom: 15px;
        font-size: 1em;
    }
    
    .back-link:hover {
        text-decoration: underline;
    }
    
    .header h1 {
        font-size: 2.2em;
        color: #333;
        margin: 0 0 10px 0;
    }
    
    .exam-id {
        color: #666;
        font-size: 0.95em;
    }
    
    .exam-id code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
    }
    
    /* Schema Viewer Styles */
    .schema-viewer-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 30px 0;
    }
    
    .schema-viewer-section h2 {
        margin-top: 0;
        color: #333;
        font-size: 1.3em;
    }
    
    .schema-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .schema-viewer-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 600px;
    }
    
    .schema-viewer-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 18px;
        border-bottom: 1px solid #eee;
        flex-shrink: 0;
    }
    
    .schema-viewer-header h3 {
        margin: 0;
        font-size: 1.1em;
        font-weight: 600;
    }
    
    .schema-viewer-box {
        flex: 1;
        padding: 0;
        overflow: auto;
        background: #f9f9f9;
        display: flex;
        align-items: stretch;
        justify-content: stretch;
    }
    
    .schema-viewer-box iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0;
        flex: 1;
    }
    
    .loading-message {
        text-align: center;
        color: #999;
        padding: 40px 20px;
        font-size: 0.95em;
        width: 100%;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        border-left: 4px solid #ddd;
    }
    
    .stat-card.total {
        border-left-color: #667eea;
    }
    
    .stat-card.evaluated {
        border-left-color: #43a047;
    }
    
    .stat-card.pending {
        border-left-color: #ff9800;
    }
    
    .stat-icon {
        font-size: 2.5em;
        opacity: 0.8;
    }
    
    .stat-content h3 {
        margin: 0;
        color: #666;
        font-size: 0.9em;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .stat-number {
        margin: 5px 0 0 0;
        font-size: 2em;
        font-weight: bold;
        color: #333;
    }
    
    .stat-percentage {
        margin: 5px 0 0 0;
        font-size: 0.85em;
        color: #999;
    }
    
    .progress-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
    }
    
    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-weight: 500;
        color: #333;
    }
    
    .progress-bar {
        background: #eee;
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .progress-fill {
        background: linear-gradient(90deg, #667eea, #764ba2);
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.85em;
        font-weight: bold;
        min-width: 40px;
        transition: width 0.3s ease;
    }
    
    .students-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 30px 0;
    }
    
    .students-section h2 {
        margin-top: 0;
        color: #333;
    }
    
    .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .students-table {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    table thead {
        background: #f5f5f5;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
    }
    
    table th {
        padding: 12px;
        text-align: left;
        color: #333;
    }
    
    table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    
    table tbody tr:hover {
        background: #f9f9f9;
    }
    
    table input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .student-id {
        font-family: monospace;
        font-size: 0.9em;
        color: #333;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .badge-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .badge-evaluated {
        background: #d4edda;
        color: #155724;
    }
    
    #evaluationStatus {
        margin-top: 20px;
    }
    
    .alert {
        padding: 16px 20px;
        border-radius: 8px;
        border-left: 4px solid;
        margin: 20px 0;
    }
    
    .alert-success {
        background: #e8f5e9;
        color: #2e7d32;
        border-left-color: #43a047;
    }
    
    .alert-info {
        background: #e3f2fd;
        color: #1565c0;
        border-left-color: #1976d2;
    }
    
    .alert-danger {
        background: #ffebee;
        color: #c62828;
        border-left-color: #ef5350;
    }
    
    .alert strong {
        display: block;
        margin-bottom: 5px;
    }
    
    .evaluated-section {
        background: #f0f8ff;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        margin: 20px 0;
    }
    
    .evaluated-section h2 {
        margin-top: 0;
    }
    
    .evaluated-table {
        overflow-x: auto;
    }
    
    .evaluated-table table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .evaluated-table thead {
        background: #f5f5f5;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
    }
    
    .evaluated-table th {
        padding: 12px;
        text-align: left;
        color: #333;
    }
    
    .evaluated-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    
    .evaluated-table tbody tr:hover {
        background: #f9f9f9;
    }
    
    .score {
        color: #667eea;
        font-weight: 600;
    }
    
    .percentage-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
        text-align: center;
        min-width: 60px;
    }
    
    .date {
        color: #999;
        font-size: 0.9em;
    }
    
    .text-center {
        text-align: center;
    }
    
    .actions {
        white-space: nowrap;
    }
    
    #reEvaluateStatus {
        margin-top: 20px;
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .controls {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
        }
    }
</style>

<script>
const form = document.getElementById('evaluationForm');
const selectAllCheckbox = document.getElementById('selectAllCheckbox');
const selectAllBtn = document.getElementById('selectAll');
const deselectAllBtn = document.getElementById('deselectAll');
const evaluateBtn = document.getElementById('evaluateBtn');
const statusDiv = document.getElementById('evaluationStatus');

// Select all checkboxes
selectAllCheckbox.addEventListener('change', (e) => {
    document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.checked = e.target.checked;
    });
    updateEvaluateButtonState();
});

selectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.checked = true;
    });
    selectAllCheckbox.checked = true;
    updateEvaluateButtonState();
});

deselectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('.student-checkbox').forEach(cb => {
        cb.checked = false;
    });
    selectAllCheckbox.checked = false;
    updateEvaluateButtonState();
});

// Update individual checkboxes
document.querySelectorAll('.student-checkbox').forEach(cb => {
    cb.addEventListener('change', updateEvaluateButtonState);
});

function updateEvaluateButtonState() {
    const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
    evaluateBtn.disabled = checkedCount === 0;
    if (checkedCount === 0) {
        evaluateBtn.textContent = 'Evaluate Selected';
    } else {
        evaluateBtn.textContent = `Evaluate Selected (${checkedCount})`;
    }
}

// Handle form submission
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const selectedStudents = Array.from(document.querySelectorAll('.student-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedStudents.length === 0) {
        statusDiv.innerHTML = '<div class="alert alert-danger">Please select at least one student.</div>';
        return;
    }
    
    statusDiv.innerHTML = `<div class="alert alert-info">Evaluating ${selectedStudents.length} student(s)... This may take a few minutes.</div>`;
    evaluateBtn.disabled = true;
    
    try {
        const response = await fetch('{{ url_for("batch_evaluate") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                exam_id: '{{ stats.exam_id }}',
                student_ids: selectedStudents
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            let alertClass = data.failed === 0 ? 'alert-success' : 'alert-info';
            
            statusDiv.innerHTML = `
                <div class="alert ${alertClass}">
                    <strong>‚úÖ Evaluation Complete!</strong>
                    <p>Successful: ${data.successful}/${data.total}</p>
                    ${data.failed > 0 ? `<p>Failed: ${data.failed}</p>` : ''}
                </div>
            `;
            
            if (data.failed === 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger"><strong>‚ùå Error:</strong> ${result.message}</div>`;
            evaluateBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error:', error);
        statusDiv.innerHTML = `<div class="alert alert-danger"><strong>‚ùå Error:</strong> ${error.message}</div>`;
        evaluateBtn.disabled = false;
    }
});

// Initialize
updateEvaluateButtonState();

// Load Schema PDF on page load
document.addEventListener('DOMContentLoaded', function() {
    const examId = "{{ stats.exam_id }}";
    
    console.log('Loading schema for exam_id:', examId);
    
    if (examId) {
        // Fetch the schema PDF path
        fetch(`/api/get-schema-pdf-path/${encodeURIComponent(examId)}`)
            .then(response => {
                console.log('Schema response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Schema response data:', data);
                
                if (data.success && data.pdf_path) {
                    // Display PDF in iframe
                    const schemaViewer = document.getElementById('schemaViewer');
                    schemaViewer.innerHTML = `
                        <iframe 
                            src="${data.pdf_path}" 
                            title="Marking Scheme PDF">
                        </iframe>
                    `;
                } else {
                    console.warn('No PDF path in response:', data.message);
                    document.getElementById('schemaViewer').innerHTML = 
                        '<p style="text-align: center; color: #999; padding: 40px 20px;">No marking scheme PDF found for this exam: ' + (data.message || 'Unknown error') + '</p>';
                }
            })
            .catch(error => {
                console.error('Could not load schema PDF:', error);
                document.getElementById('schemaViewer').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 40px 20px;">Could not load marking scheme: ' + error.message + '</p>';
            });
    } else {
        console.error('No exam_id found');
    }
});

// Re-evaluate function
async function reEvaluateStudent(examId, studentId) {
    const shortStudentId = studentId.length > 16 ? studentId.substring(0, 16) + '...' : studentId;
    
    const confirmed = confirm(
        `Re-evaluate ${shortStudentId}?\n\n` +
        `This will run the evaluation again with the same marking scheme.\n` +
        `The previous result will be replaced with the new one.`
    );
    
    if (!confirmed) return;
    
    const statusDiv = document.getElementById('reEvaluateStatus');
    statusDiv.innerHTML = `<div class="alert alert-info">Re-evaluating ${shortStudentId}... This may take a minute.</div>`;
    
    try {
        const response = await fetch(
            `/api/re-evaluate/${encodeURIComponent(examId)}/${encodeURIComponent(studentId)}`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }
        );
        
        const result = await response.json();
        
        if (result.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ Re-evaluation Complete!</strong>
                    <p>Student: ${shortStudentId}</p>
                    <p>New Score: ${result.data.total_scored}/${result.data.total_max} (${result.data.percentage}%)</p>
                    <p>The page will reload to show updated results.</p>
                </div>
            `;
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger"><strong>‚ùå Error:</strong> ${result.message}</div>`;
        }
    } catch (error) {
        console.error('Re-evaluate error:', error);
        statusDiv.innerHTML = `<div class="alert alert-danger"><strong>‚ùå Error:</strong> ${error.message}</div>`;
    }
}
</script>
{% endblock %}
