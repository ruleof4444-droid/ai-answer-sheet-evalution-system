{% extends "base.html" %}

{% block title %}Evaluation Results - Answer Sheet Evaluation System{% endblock %}

{% block content %}
<div class="results-container">
    {% if evaluation %}
        {% set total_questions = evaluation.per_question|length %}
        {% set flagged_questions = evaluation.per_question | selectattr('flags') | list | length %}
        {% set ai_feedback = evaluation.per_question | selectattr('verification') | list | length %}
        {% set avg_similarity = ((evaluation.per_question | sum(attribute='similarity')) / total_questions) if total_questions else 0 %}
        {% set avg_confidence = ((evaluation.per_question | sum(attribute='ocr_confidence')) / total_questions) if total_questions else 0 %}
        {% set consistency_score = (((total_questions - flagged_questions) / total_questions) * 100) if total_questions else 0 %}
        {% set overall_pct = evaluation.overall.percentage %}
        {% if overall_pct >= 90 %}
            {% set performance_label = 'Outstanding' %}
            {% set performance_class = 'success' %}
        {% elif overall_pct >= 75 %}
            {% set performance_label = 'Strong' %}
            {% set performance_class = 'info' %}
        {% elif overall_pct >= 60 %}
            {% set performance_label = 'On Track' %}
            {% set performance_class = 'notice' %}
        {% else %}
            {% set performance_label = 'Needs Attention' %}
            {% set performance_class = 'warning' %}
        {% endif %}
        {% if performance_class == 'success' %}
            {% set gauge_color = '#10b981' %}
        {% elif performance_class == 'info' %}
            {% set gauge_color = '#6366f1' %}
        {% elif performance_class == 'notice' %}
            {% set gauge_color = '#f97316' %}
        {% else %}
            {% set gauge_color = '#ef4444' %}
        {% endif %}
        {% set avg_similarity_pct = (avg_similarity * 100) if avg_similarity else 0 %}
        {% set avg_confidence_pct = (avg_confidence * 100) if avg_confidence else 0 %}

        <div class="page-header">
            <div>
                <p class="eyebrow">Evaluation Summary</p>
                <h1>üìä Student Performance Overview</h1>
                <p class="description">Detailed analytics for exam {{ evaluation.exam_id[:16] }}&hellip; and student {{ evaluation.student_id[:16] }}&hellip;</p>
            </div>
            <div class="header-meta">
                <div class="meta-chip">
                    <span>Exam ID</span>
                    <strong>{{ evaluation.exam_id }}</strong>
                </div>
                <div class="meta-chip">
                    <span>Student ID</span>
                    <strong>{{ evaluation.student_id }}</strong>
                </div>
                <div class="meta-chip secondary">
                    <span>Generated</span>
                    <strong>{{ evaluation.generated_at }}</strong>
                </div>
            </div>
        </div>
        
        <!-- Overall Score -->
        <div class="score-grid">
            <div class="score-card">
                <div class="score-gauge">
                    <div class="gauge-ring" style="--gauge-value: {{ evaluation.overall.percentage }}; --gauge-color: {{ gauge_color }};">
                        <div class="gauge-fill">
                            <span>{{ evaluation.overall.percentage }}%</span>
                            <small>overall</small>
                            <p>{{ evaluation.overall.total_scored }} / {{ evaluation.overall.total_max }}</p>
                        </div>
                    </div>
                </div>
                <div class="score-meta">
                    <p>Total Marks</p>
                    <h2>{{ evaluation.overall.total_scored }} / {{ evaluation.overall.total_max }}</h2>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ evaluation.overall.percentage }}%"></div>
                    </div>
                    <small>Auto-evaluated score based on rubric alignment</small>

                    <div class="score-badges">
                        <span class="badge-pill {{ performance_class }}">Performance ¬∑ {{ performance_label }}</span>
                        <span class="badge-pill neutral">Consistency {{ consistency_score|round(0) }}%</span>
                        <span class="badge-pill ghost">Avg OCR {{ avg_confidence_pct|round(0) }}%</span>
                    </div>

                    <div class="score-insights">
                        <div class="insight-card">
                            <p>Avg Similarity</p>
                            <h4>{{ avg_similarity_pct|round(1) }}%</h4>
                            <div class="insight-progress">
                                <span style="width: {{ avg_similarity_pct|round(0) }}%;"></span>
                            </div>
                            <small>Alignment with marking scheme</small>
                        </div>
                        <div class="insight-card">
                            <p>AI Reviews</p>
                            <h4>{{ ai_feedback }}</h4>
                            <small>{{ 'Insight generated' if ai_feedback == 1 else 'Insights generated' }}</small>
                        </div>
                        <div class="insight-card">
                            <p>Flags Cleared</p>
                            <h4>{{ total_questions - flagged_questions }}</h4>
                            <small>of {{ total_questions }} questions</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="score-stats">
                <div class="stat-card">
                    <span>Questions Evaluated</span>
                    <strong>{{ total_questions }}</strong>
                </div>
                <div class="stat-card">
                    <span>Flagged Questions</span>
                    <strong>{{ flagged_questions }}</strong>
                </div>
                <div class="stat-card">
                    <span>AI Insights</span>
                    <strong>{{ ai_feedback }}</strong>
                </div>
            </div>
        </div>
        
        <!-- Per-Question Results with PDF Viewer -->
        <div class="questions-section">
            <div class="section-heading">
                <div>
                    <p class="eyebrow">Deep Dive</p>
                    <h2>üìã Question-wise Evaluation</h2>
                </div>
                <div class="heading-actions">
                    <button class="chip-btn active" onclick="filterQuestions('all')" data-filter="all">All</button>
                    <button class="chip-btn" onclick="filterQuestions('flagged')" data-filter="flagged">Flagged</button>
                </div>
            </div>
            <div class="questions-layout">
                <!-- Left: Question Cards -->
                <div class="questions-container">
                    <div class="questions-grid">
                        {% for q in evaluation.per_question %}
                            <div class="question-card{% if q.flags %} flagged{% endif %}" data-question-card data-has-flags="{{ 'true' if q.flags else 'false' }}">
                                <div class="question-header">
                                    <div>
                                        <p class="eyebrow">Question {{ q.question_number }}</p>
                                        <h3>Score {{ q.scored_marks }}/{{ q.max_marks }}</h3>
                                    </div>
                                    <div class="question-tags">
                                        {% if q.flags %}
                                            <span class="status-pill danger">üö© Flagged</span>
                                        {% endif %}
                                        {% if q.gemini_marks %}
                                            <span class="status-pill info">ü§ñ Agent: {{ q.gemini_marks }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="question-body">
                                    <div class="metric-grid">
                                        <div class="metric-card">
                                            <span>Similarity</span>
                                            <strong>{{ "%.2f"|format(q.similarity) }}</strong>
                                        </div>
                                        <div class="metric-card">
                                            <span>OCR Confidence</span>
                                            <strong>{{ "%.2f"|format(q.ocr_confidence) }}</strong>
                                        </div>
                                        <div class="metric-card">
                                            <span>Score %</span>
                                            <strong>{{ "%.0f"|format((q.scored_marks / q.max_marks * 100) if q.max_marks else 0) }}%</strong>
                                        </div>
                                    </div>
                                    
                                    {% if q.flags %}
                                        <div class="flags-section" 
                                             data-question-number="{{ q.question_number }}"
                                             data-exam-id="{{ evaluation.exam_id }}"
                                             data-student-id="{{ evaluation.student_id }}"
                                             data-flags="{{ q.flags|tojson|safe }}">
                                            <div class="flags-header">
                                                <strong>Review Flags</strong>
                                                <button type="button" class="btn-remove-flag" 
                                                        onclick="openRemoveFlagModalFromCard(this)"
                                                        title="Remove Flag">
                                                    Clear Flags
                                                </button>
                                            </div>
                                            <ul>
                                                {% for flag in q.flags %}
                                                    <li>{{ flag }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                    
                                    {% if q.verification %}
                                        <div class="verification-section">
                                            <strong>AI Insight</strong>
                                            <p>{{ q.verification.reason }}</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Right: PDF Viewer -->
                <div class="pdf-viewer-container">
                    <div class="pdf-viewer-header">
                        <h3>üìÑ Answer Script</h3>
                    </div>
                    <div id="pdfViewer" class="pdf-viewer-box">
                        <p class="loading-message">Loading answer script...</p>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Load PDF viewer & setup filters
            document.addEventListener('DOMContentLoaded', function() {
                const examId = "{{ evaluation.exam_id }}";
                const studentId = "{{ evaluation.student_id }}";
                
                if (examId && studentId) {
                    fetch(`/api/get-pdf-path/${encodeURIComponent(examId)}/${encodeURIComponent(studentId)}`)
                        .then(response => response.json())
                        .then(data => {
                            const pdfViewer = document.getElementById('pdfViewer');
                            if (data.success && data.pdf_path) {
                                pdfViewer.innerHTML = `
                                    <iframe 
                                        src="${data.pdf_path}" 
                                        style="width: 100%; height: 100%; border: none; border-radius: 4px;"
                                        title="Answer Script PDF">
                                    </iframe>
                                `;
                            } else {
                                pdfViewer.innerHTML = '<p class="loading-message">No answer script PDF found for this student</p>';
                            }
                        })
                        .catch(error => {
                            console.log('Could not load PDF:', error);
                            document.getElementById('pdfViewer').innerHTML = 
                                '<p class="loading-message">Could not load answer script</p>';
                        });
                }
                
                // initialize filter state
                filterQuestions('all');
            });
            
            const filterButtons = document.querySelectorAll('.chip-btn');
            const questionCards = document.querySelectorAll('[data-question-card]');
            
            function setActiveButton(mode) {
                filterButtons.forEach(btn => {
                    if (btn.dataset.filter === mode) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
            
            function filterQuestions(mode) {
                if (!questionCards.length) return;
                questionCards.forEach(card => {
                    const hasFlags = card.getAttribute('data-has-flags') === 'true';
                    const shouldShow = mode === 'all' || (mode === 'flagged' && hasFlags);
                    card.style.display = shouldShow ? '' : 'none';
                });
                setActiveButton(mode);
            }
            
            window.filterQuestions = filterQuestions;
        </script>

        <!-- Remove Flag Modal -->
        <div id="removeFlagModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Remove Flag</h2>
                    <span class="close" onclick="closeRemoveFlagModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <p><strong>Question:</strong> <span id="modal_question_number"></span></p>
                    <p><strong>Student:</strong> <span id="modal_student_id"></span></p>
                    <p><strong>Exam:</strong> <span id="modal_exam_id"></span></p>
                    
                    <div class="flags-section">
                        <label><strong>Select flags to remove:</strong></label>
                        <div id="modal_flags_list"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="remove_reason">Reason (optional):</label>
                        <textarea id="remove_reason" rows="3" placeholder="Enter reason for removing flag..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeRemoveFlagModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmRemoveFlag()">Remove Flag(s)</button>
                </div>
            </div>
        </div>

        <script>
            // Remove Flag functionality
            let currentRemoveContext = null;

            function openRemoveFlagModalFromCard(button) {
                try {
                    const flagsSection = button.closest('.flags-section');
                    if (!flagsSection) {
                        console.error('Could not find flags-section');
                        alert('Error: Could not find flag section');
                        return;
                    }
                    
                    const examId = flagsSection.getAttribute('data-exam-id');
                    const studentId = flagsSection.getAttribute('data-student-id');
                    const questionNumber = parseInt(flagsSection.getAttribute('data-question-number'));
                    const flagsJson = flagsSection.getAttribute('data-flags');
                    
                    if (!examId || !studentId || !questionNumber || !flagsJson) {
                        console.error('Missing data attributes:', { examId, studentId, questionNumber, flagsJson });
                        alert('Error: Missing required data');
                        return;
                    }
                    
                    let flags;
                    try {
                        flags = JSON.parse(flagsJson);
                    } catch (e) {
                        console.error('Error parsing flags JSON:', e, flagsJson);
                        alert('Error parsing flags data');
                        return;
                    }
                    
                    openRemoveFlagModal(examId, studentId, questionNumber, flags);
                } catch (error) {
                    console.error('Error in openRemoveFlagModalFromCard:', error);
                    alert('Error opening remove flag modal: ' + error.message);
                }
            }

            function openRemoveFlagModal(examId, studentId, questionNumber, flags) {
                try {
                    if (!Array.isArray(flags)) {
                        console.error('Flags is not an array:', flags);
                        alert('Error: Invalid flags data');
                        return;
                    }
                    
                    currentRemoveContext = {
                        exam_id: examId,
                        student_id: studentId,
                        question_number: questionNumber,
                        flags: flags
                    };
                    
                    const modal = document.getElementById('removeFlagModal');
                    if (!modal) {
                        console.error('Modal not found');
                        alert('Error: Modal not found');
                        return;
                    }
                    
                    const questionSpan = document.getElementById('modal_question_number');
                    const studentSpan = document.getElementById('modal_student_id');
                    const examSpan = document.getElementById('modal_exam_id');
                    const flagsList = document.getElementById('modal_flags_list');
                    
                    if (!questionSpan || !studentSpan || !examSpan || !flagsList) {
                        console.error('Modal elements not found');
                        alert('Error: Modal elements not found');
                        return;
                    }
                    
                    questionSpan.textContent = `Question ${questionNumber}`;
                    studentSpan.textContent = studentId.length > 30 ? studentId.substring(0, 30) + '...' : studentId;
                    examSpan.textContent = examId.length > 30 ? examId.substring(0, 30) + '...' : examId;
                    
                    // Create checkboxes for each flag
                    flagsList.innerHTML = '';
                    
                    flags.forEach((flag, flagIndex) => {
                        const checkbox = document.createElement('div');
                        checkbox.className = 'flag-checkbox';
                        checkbox.innerHTML = `
                            <label>
                                <input type="checkbox" value="${flagIndex}" checked>
                                <span>${escapeHtml(String(flag))}</span>
                            </label>
                        `;
                        flagsList.appendChild(checkbox);
                    });
                    
                    // Add "Remove All" option
                    const removeAllDiv = document.createElement('div');
                    removeAllDiv.className = 'flag-checkbox';
                    removeAllDiv.innerHTML = `
                        <label>
                            <input type="checkbox" id="remove_all_flags">
                            <span><strong>Remove All Flags</strong></span>
                        </label>
                    `;
                    flagsList.appendChild(removeAllDiv);
                    
                    modal.style.display = 'block';
                } catch (error) {
                    console.error('Error in openRemoveFlagModal:', error);
                    alert('Error opening modal: ' + error.message);
                }
            }

            function closeRemoveFlagModal() {
                document.getElementById('removeFlagModal').style.display = 'none';
                document.getElementById('remove_reason').value = '';
                currentRemoveContext = null;
            }

            function confirmRemoveFlag() {
                if (!currentRemoveContext) return;
                
                const removeAll = document.getElementById('remove_all_flags').checked;
                const checkboxes = document.querySelectorAll('#modal_flags_list input[type="checkbox"]:not(#remove_all_flags)');
                
                let flagsToRemove = [];
                
                if (removeAll) {
                    flagsToRemove = currentRemoveContext.flags;
                } else {
                    checkboxes.forEach(cb => {
                        if (cb.checked) {
                            flagsToRemove.push(currentRemoveContext.flags[parseInt(cb.value)]);
                        }
                    });
                }
                
                if (flagsToRemove.length === 0) {
                    alert('Please select at least one flag to remove.');
                    return;
                }
                
                const reason = document.getElementById('remove_reason').value.trim();
                
                fetch('/api/remove-flag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        exam_id: currentRemoveContext.exam_id,
                        student_id: currentRemoveContext.student_id,
                        question_number: currentRemoveContext.question_number,
                        flags_to_remove: flagsToRemove,
                        reason: reason || 'Manual removal by user'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        closeRemoveFlagModal();
                        // Reload the page to show updated flags
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error removing flag: ' + error.message);
                });
            }

            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return String(text).replace(/[&<>"']/g, m => map[m]);
            }

            // Close modal when clicking outside
            document.addEventListener('click', function(event) {
                const modal = document.getElementById('removeFlagModal');
                if (modal && event.target == modal) {
                    closeRemoveFlagModal();
                }
            });

            // Debug and add event listeners as backup
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Remove Flag functionality loaded');
                const removeButtons = document.querySelectorAll('.btn-remove-flag');
                console.log('Found', removeButtons.length, 'remove flag buttons');
                
                // Add event listeners to all remove flag buttons as backup
                removeButtons.forEach((btn, index) => {
                    console.log('Setting up button', index, ':', btn);
                    
                    // Remove existing onclick if any and use addEventListener instead
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Button clicked via event listener');
                        openRemoveFlagModalFromCard(this);
                    });
                });
                
                // Verify modal exists
                const modal = document.getElementById('removeFlagModal');
                if (modal) {
                    console.log('Modal found in DOM');
                } else {
                    console.error('Modal NOT found in DOM!');
                }
            });
            
            // Make functions globally available
            window.openRemoveFlagModalFromCard = openRemoveFlagModalFromCard;
            window.openRemoveFlagModal = openRemoveFlagModal;
            window.closeRemoveFlagModal = closeRemoveFlagModal;
            window.confirmRemoveFlag = confirmRemoveFlag;
        </script>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <a href="{{ url_for('manual_evaluation', exam_id=evaluation.exam_id, student_id=evaluation.student_id) }}" class="btn btn-primary">
                ‚úèÔ∏è Manual Evaluation
            </a>
            <a href="{{ url_for('pdf_viewer', exam_id=evaluation.exam_id, student_id=evaluation.student_id) }}" class="btn btn-secondary">
                üìÑ View Extracted Text
            </a>
            <a href="{{ url_for('results') }}" class="btn btn-secondary">
                üìä Back to Results
            </a>
        </div>
    {% else %}
        <div class="alert alert-warning">
            <strong>No evaluation results found</strong>
            <p>Please go to the Evaluate section to run an evaluation.</p>
        </div>
    {% endif %}
</div>

<style>
    .results-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .page-header {
        margin-bottom: var(--spacing-2xl);
        display: flex;
        justify-content: space-between;
        gap: var(--spacing-xl);
        flex-wrap: wrap;
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: var(--spacing-sm);
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .description {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin: 0;
    }
    
    .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.75rem;
        color: var(--text-tertiary);
        margin-bottom: var(--spacing-xs);
    }
    
    .header-meta {
        display: flex;
        gap: var(--spacing-md);
        flex-wrap: wrap;
        align-items: flex-start;
    }
    
    .meta-chip {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md) var(--spacing-lg);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
        min-width: 220px;
    }
    
    .meta-chip.secondary {
        background: var(--bg-secondary);
    }
    
    .meta-chip span {
        display: block;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-tertiary);
        margin-bottom: var(--spacing-xs);
    }
    
    .meta-chip strong {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    .score-grid {
        display: grid;
        grid-template-columns: 1.4fr 0.6fr;
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-2xl);
    }
    
    .score-card {
        background: var(--bg-primary);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        display: flex;
        gap: var(--spacing-xl);
        align-items: center;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-light);
    }
    
    .score-gauge {
        width: 220px;
        height: 220px;
        position: relative;
    }
    
    .gauge-ring {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(var(--gauge-color, #667eea) calc(var(--gauge-value) * 1%), rgba(226, 232, 240, 0.85) 0);
        box-shadow: 0 15px 35px rgba(15, 23, 42, 0.18), inset 0 0 30px rgba(15, 23, 42, 0.08);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .gauge-ring::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.35), transparent 70%);
        mix-blend-mode: screen;
    }
    
    .gauge-ring::after {
        content: '';
        position: absolute;
        inset: 10px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
        opacity: 0.4;
    }
    
    .gauge-fill {
        position: absolute;
        inset: 0;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.15rem;
        text-align: center;
        color: #0f172a;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.6);
        z-index: 1;
        padding: var(--spacing-md);
    }
    
    .gauge-fill span {
        font-size: 2.8rem;
        font-weight: 700;
        color: #0f172a;
        line-height: 1.2;
    }
    
    .gauge-fill small {
        text-transform: uppercase;
        letter-spacing: 0.25em;
        font-size: 0.7rem;
        color: rgba(15, 23, 42, 0.6);
    }
    
    .gauge-fill p {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: rgba(15, 23, 42, 0.85);
    }
    
    .score-meta {
        flex: 1;
    }
    
    .score-meta p {
        margin-bottom: var(--spacing-xs);
        color: var(--text-secondary);
    }
    
    .score-meta h2 {
        margin: 0 0 var(--spacing-sm) 0;
        font-size: 2rem;
        color: var(--text-primary);
    }
    
    .progress-bar {
        background: var(--bg-tertiary);
        height: 30px;
        border-radius: var(--radius-full);
        overflow: hidden;
        margin-bottom: var(--spacing-xs);
    }
    
    .progress-fill {
        background: var(--primary-gradient);
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }
    
    .score-meta small {
        color: var(--text-tertiary);
    }

    .score-badges {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
        margin: var(--spacing-md) 0;
    }

    .badge-pill {
        border-radius: var(--radius-full);
        padding: 0.35rem 1rem;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 600;
        border: 1px solid var(--border-light);
        color: var(--text-secondary);
        background: var(--bg-secondary);
    }

    .badge-pill.success {
        background: rgba(16, 185, 129, 0.15);
        color: #047857;
        border-color: rgba(16, 185, 129, 0.4);
    }

    .badge-pill.info {
        background: rgba(59, 130, 246, 0.15);
        color: #1d4ed8;
        border-color: rgba(59, 130, 246, 0.3);
    }

    .badge-pill.notice {
        background: rgba(249, 115, 22, 0.15);
        color: #c2410c;
        border-color: rgba(249, 115, 22, 0.3);
    }

    .badge-pill.warning {
        background: rgba(239, 68, 68, 0.15);
        color: #b91c1c;
        border-color: rgba(239, 68, 68, 0.3);
    }

    .badge-pill.neutral {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
    }

    .badge-pill.ghost {
        background: transparent;
        color: var(--text-tertiary);
        border-style: dashed;
    }

    .score-insights {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .insight-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .insight-card p {
        margin: 0;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-tertiary);
    }

    .insight-card h4 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--text-primary);
    }

    .insight-card small {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .insight-progress {
        height: 6px;
        border-radius: var(--radius-full);
        background: var(--bg-tertiary);
        overflow: hidden;
        margin-top: 0.2rem;
    }

    .insight-progress span {
        display: block;
        height: 100%;
        background: var(--primary-gradient);
    }
    
    .score-stats {
        display: grid;
        gap: var(--spacing-md);
    }
    
    .stat-card {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-md);
    }
    
    .stat-card span {
        display: block;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-tertiary);
        margin-bottom: var(--spacing-xs);
    }
    
    .stat-card strong {
        font-size: 1.75rem;
        color: var(--text-primary);
    }
    
    .questions-section {
        margin-bottom: var(--spacing-2xl);
    }
    
    .section-heading {
        display: flex;
        justify-content: space-between;
        gap: var(--spacing-md);
        align-items: center;
        flex-wrap: wrap;
    }
    
    .heading-actions {
        display: flex;
        gap: var(--spacing-sm);
    }
    
    .chip-btn {
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        padding: 0.4rem 1rem;
        border-radius: var(--radius-full);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        color: var(--text-secondary);
    }
    
    .chip-btn.active,
    .chip-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        box-shadow: var(--shadow-sm);
    }
    
    .questions-layout {
        display: grid;
        grid-template-columns: 1fr 1.4fr;
        gap: var(--spacing-xl);
        margin-top: var(--spacing-xl);
    }
    
    .questions-container {
        display: flex;
        flex-direction: column;
    }
    
    .questions-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .pdf-viewer-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 800px;
        position: sticky;
        top: 20px;
    }
    
    .pdf-viewer-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 18px;
        border-bottom: 1px solid #eee;
        flex-shrink: 0;
    }
    
    .pdf-viewer-header h3 {
        margin: 0;
        font-size: 1.1em;
        font-weight: 600;
    }
    
    .pdf-viewer-box {
        flex: 1;
        padding: 0;
        overflow: auto;
        background: #f9f9f9;
        display: flex;
        align-items: stretch;
        justify-content: stretch;
    }
    
    .pdf-viewer-box img,
    .pdf-viewer-box canvas {
        max-width: 100%;
        height: auto;
        padding: 10px;
    }
    
    .pdf-viewer-box iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0;
        flex: 1;
    }
    
    .loading-message {
        text-align: center;
        color: #999;
        padding: 40px 20px;
        font-size: 0.95em;
    }
    
    .question-card {
        background: var(--bg-primary);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-light);
        padding: var(--spacing-lg);
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .question-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }
    
    .question-card.flagged {
        border-color: var(--warning-color);
    }
    
    .question-header {
        display: flex;
        justify-content: space-between;
        gap: var(--spacing-md);
        align-items: center;
        margin-bottom: var(--spacing-md);
    }
    
    .question-header h3 {
        margin: 0;
        color: var(--text-primary);
    }
    
    .question-tags {
        display: flex;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    
    .status-pill {
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid transparent;
    }
    
    .status-pill.danger {
        background: rgba(239, 68, 68, 0.1);
        color: #b91c1c;
        border-color: rgba(239, 68, 68, 0.3);
    }
    
    .status-pill.info {
        background: rgba(59, 130, 246, 0.1);
        color: #1d4ed8;
        border-color: rgba(59, 130, 246, 0.3);
    }
    
    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }
    
    .metric-card {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        border: 1px solid var(--border-light);
        text-align: center;
    }
    
    .metric-card span {
        display: block;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-tertiary);
        margin-bottom: var(--spacing-xs);
    }
    
    .metric-card strong {
        font-size: 1.35rem;
        color: var(--text-primary);
    }
    
    .flags-section, .verification-section {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-light);
        padding: var(--spacing-md);
        margin-top: var(--spacing-md);
    }
    
    .flags-section {
        border-left: 4px solid var(--warning-color);
    }
    
    .verification-section {
        border-left: 4px solid var(--primary-color);
    }
    
    .flags-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-sm);
    }
    
    .flags-section strong, .verification-section strong {
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.85rem;
    }
    
    .btn-remove-flag {
        padding: 0.4rem 0.9rem;
        border-radius: var(--radius-full);
        border: none;
        background: var(--primary-gradient);
        color: white;
        cursor: pointer;
        font-size: 0.8rem;
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .btn-remove-flag:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }
    
    .flags-section ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .flags-section li {
        margin: 3px 0;
        color: #555;
    }
    
    .verification-section p {
        margin: 5px 0;
        color: #555;
    }
    
    .action-buttons {
        display: flex;
        gap: var(--spacing-md);
        justify-content: center;
        margin-top: var(--spacing-xl);
        flex-wrap: wrap;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: auto;
    }
    
    .modal-content {
        background-color: white;
        margin: 2% auto;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        background: white;
    }
    
    .modal-header h2 {
        margin: 0;
        color: #333;
    }
    
    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
    }
    
    .close:hover {
        color: #000;
    }
    
    .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
        max-height: calc(90vh - 160px);
    }
    
    .modal-body p {
        margin: 10px 0;
    }
    
    .modal-body .flags-section {
        margin: 20px 0;
        background: #f9f9f9;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .flag-checkbox {
        margin: 10px 0;
        padding: 10px;
        background: white;
        border-radius: 4px;
    }
    
    .flag-checkbox label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }
    
    .form-group {
        margin: 20px 0;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
    }
    
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.95em;
        resize: vertical;
        box-sizing: border-box;
    }
    
    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        flex-shrink: 0;
        background: white;
    }
    
    /* Ensure modal body scrolls smoothly */
    .modal-body::-webkit-scrollbar {
        width: 8px;
    }
    
    .modal-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .modal-body::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    
    .modal-body::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* Also make flags section scrollable if content is too long */
    .modal-body .flags-section::-webkit-scrollbar {
        width: 6px;
    }
    
    .modal-body .flags-section::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .modal-body .flags-section::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    
    @media (max-width: 1200px) {
        .score-grid {
            grid-template-columns: 1fr;
        }
        
        .questions-layout {
            grid-template-columns: 1fr;
        }
        
        .pdf-viewer-container {
            position: static;
            height: 600px;
        }
    }
    
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
        }
        
        .header-meta {
            flex-direction: column;
            width: 100%;
        }
        
        .score-card {
            flex-direction: column;
            text-align: center;
        }
        
        .score-gauge {
            margin: 0 auto;
        }

        .score-badges {
            justify-content: center;
        }

        .score-insights {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }
        
        .questions-grid {
            grid-template-columns: 1fr;
        }
        
        .pdf-viewer-container {
            height: 400px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}
