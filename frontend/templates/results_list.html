{% extends "base.html" %}

{% block title %}Results List - Answer Sheet Evaluation System{% endblock %}

{% block content %}
<div class="results-list-container">
    <div class="page-header">
        <div>
            <h1>ðŸ“Š Evaluation Results</h1>
            <p class="description">View all completed evaluations or jump straight to a specific student.</p>
        </div>
    </div>
    
    {% if results %}
        <div class="results-card">
            <div class="results-toolbar">
                <div class="search-block">
                    <label for="studentSearch">Search by Student ID</label>
                    <div class="search-input">
                        <input type="text" id="studentSearch" placeholder="e.g., S12345 or part of the ID">
                        <button type="button" class="btn btn-secondary" onclick="filterResults()">Search</button>
                    </div>
                    <small>Use the search box to quickly locate a student's evaluation.</small>
                </div>
                <div class="results-meta">
                    <div class="meta-badge">
                        <span>Total Records</span>
                        <strong id="totalResults">{{ results|length }}</strong>
                    </div>
                    <div class="meta-badge secondary">
                        <span>Visible</span>
                        <strong id="visibleResults">{{ results|length }}</strong>
                    </div>
                </div>
            </div>
            
            <div class="results-table">
                <table>
                    <thead>
                        <tr>
                            <th>Exam ID</th>
                            <th>Student ID</th>
                            <th>Score</th>
                            <th>Percentage</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        {% for result in results %}
                            <tr data-student-id="{{ result.student_id|lower }}">
                                <td class="id-cell"><code>{{ result.exam_id[:16] }}...</code></td>
                                <td class="id-cell"><code>{{ result.student_id }}</code></td>
                                <td class="score-cell">{{ result.overall.total_scored }}/{{ result.overall.total_max }}</td>
                                <td>
                                    <div class="percentage-bar">
                                        <div class="percentage-fill" style="width: {{ result.overall.percentage }}%">
                                            {{ result.overall.percentage }}%
                                        </div>
                                    </div>
                                </td>
                                <td class="text-muted">{{ result.generated_at }}</td>
                                <td class="actions-cell">
                                    <a href="{{ url_for('results', exam_id=result.exam_id, student_id=result.student_id) }}" class="btn btn-sm btn-primary">View</a>
                                    <a href="{{ url_for('pdf_viewer', exam_id=result.exam_id, student_id=result.student_id) }}" class="btn btn-sm btn-secondary">OCR</a>
                                    <button onclick="deleteScript('{{ result.exam_id }}', '{{ result.student_id }}')" class="btn btn-sm btn-danger" title="Delete this script and all associated data">Delete</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning">
            <strong>No results found</strong>
            <p>Start by uploading schemas and scripts, then run evaluations to see results here.</p>
            <a href="{{ url_for('upload_schema') }}" class="btn btn-primary">Upload Schema</a>
            <a href="{{ url_for('upload_script') }}" class="btn btn-primary">Upload Script</a>
        </div>
    {% endif %}
</div>

<style>
    .results-list-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: var(--spacing-sm);
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .description {
        color: var(--text-secondary);
        font-size: 1.125rem;
        margin-bottom: var(--spacing-2xl);
    }
    
    .results-card {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-light);
        overflow: hidden;
    }
    
    .results-toolbar {
        display: flex;
        justify-content: space-between;
        gap: var(--spacing-xl);
        flex-wrap: wrap;
        padding: var(--spacing-xl);
        border-bottom: 1px solid var(--border-light);
        background: var(--bg-secondary);
    }
    
    .search-block {
        flex: 1;
        min-width: 280px;
    }
    
    .search-block label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
        display: block;
    }
    
    .search-input {
        display: flex;
        gap: var(--spacing-sm);
    }
    
    .search-input input {
        flex: 1;
    }
    
    .search-block small {
        display: block;
        margin-top: var(--spacing-sm);
        color: var(--text-tertiary);
    }
    
    .results-meta {
        display: flex;
        gap: var(--spacing-md);
        align-items: stretch;
        flex-wrap: wrap;
    }
    
    .meta-badge {
        background: var(--bg-primary);
        border-radius: var(--radius-md);
        padding: var(--spacing-md) var(--spacing-lg);
        min-width: 140px;
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
    }
    
    .meta-badge.secondary {
        background: var(--bg-tertiary);
    }
    
    .meta-badge span {
        display: block;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-tertiary);
        margin-bottom: var(--spacing-xs);
    }
    
    .meta-badge strong {
        font-size: 1.5rem;
        color: var(--text-primary);
    }
    
    .results-table {
        overflow-x: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    table th {
        padding: var(--spacing-md);
        text-align: left;
        color: var(--text-secondary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    table td {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-light);
    }
    
    table tbody tr {
        transition: background var(--transition-fast);
    }
    
    table tbody tr:hover {
        background: var(--bg-secondary);
    }
    
    .id-cell {
        font-family: var(--font-mono);
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    
    .score-cell {
        font-weight: 500;
        color: #333;
    }
    
    .percentage-bar {
        background: var(--bg-tertiary);
        height: 28px;
        border-radius: var(--radius-full);
        overflow: hidden;
        min-width: 120px;
    }
    
    .percentage-fill {
        background: var(--primary-gradient);
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .actions-cell {
        white-space: nowrap;
    }
    
    .actions-cell .btn {
        margin-right: var(--spacing-xs);
        margin-bottom: var(--spacing-xs);
    }
    
    .actions-cell .btn:last-child {
        margin-right: 0;
    }
    
    .alert {
        background: #fff3e0;
        color: #e65100;
        padding: var(--spacing-xl);
        border-radius: var(--radius-lg);
        border-left: 4px solid #ff9800;
        box-shadow: var(--shadow-md);
    }
    
    .alert strong {
        display: block;
        margin-bottom: var(--spacing-sm);
    }
    
    .alert p {
        margin: 0 0 var(--spacing-md) 0;
    }
    
    @media (max-width: 768px) {
        .results-toolbar {
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .search-block {
            width: 100%;
        }
        
        .search-input {
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .search-input input {
            width: 100%;
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .search-input button {
            width: 100%;
        }
        
        .results-meta {
            width: 100%;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .meta-badge {
            width: 100%;
            text-align: center;
        }
        
        .results-table {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            min-width: 600px;
        }
        
        .actions-cell {
            white-space: normal;
        }
        
        .actions-cell .btn {
            display: block;
            width: 100%;
            margin-bottom: var(--spacing-xs);
        }
        
        .actions-cell .btn:last-child {
            margin-bottom: 0;
        }
    }
    
    @media (max-width: 480px) {
        .page-header h1 {
            font-size: 1.75rem;
        }
        
        .description {
            font-size: 0.9rem;
        }
        
        table {
            font-size: 0.8rem;
            min-width: 500px;
        }
        
        .id-cell code {
            font-size: 0.7rem;
        }
        
        .percentage-bar {
            min-width: 80px;
        }
        
        .percentage-fill {
            font-size: 0.75rem;
        }
    }
</style>

<script>
const studentSearchInput = document.getElementById('studentSearch');
const resultsTableBody = document.getElementById('resultsTableBody');
const visibleResultsCount = document.getElementById('visibleResults');
let filterTimeout;

function filterResults() {
    if (!resultsTableBody) return;
    
    const query = studentSearchInput.value.trim().toLowerCase();
    let visibleCount = 0;
    
    resultsTableBody.querySelectorAll('tr').forEach(row => {
        const studentId = row.getAttribute('data-student-id');
        const matches = !query || (studentId && studentId.includes(query));
        row.style.display = matches ? '' : 'none';
        if (matches) visibleCount += 1;
    });
    
    if (visibleResultsCount) {
        visibleResultsCount.textContent = visibleCount;
    }
}

if (studentSearchInput) {
    studentSearchInput.addEventListener('input', () => {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(filterResults, 200);
    });
}

async function deleteScript(examId, studentId) {
    // Confirm deletion
    const shortExamId = examId.length > 12 ? examId.substring(0, 12) + '...' : examId;
    const shortStudentId = studentId.length > 12 ? studentId.substring(0, 12) + '...' : studentId;
    
    const confirmed = confirm(
        `Are you sure you want to delete the script for:\n` +
        `Exam: ${shortExamId}\n` +
        `Student: ${shortStudentId}\n\n` +
        `This will permanently delete:\n` +
        `- The answer script\n` +
        `- OCR extracted text\n` +
        `- Evaluation results\n` +
        `- Manual evaluations\n\n` +
        `This action cannot be undone.`
    );
    
    if (!confirmed) {
        return;
    }
    
    try {
        const response = await fetch(
            `/api/delete-script/${encodeURIComponent(examId)}/${encodeURIComponent(studentId)}`,
            {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            }
        );
        
        const result = await response.json();
        
        if (result.success) {
            alert('Script deleted successfully. Page will reload.');
            window.location.reload();
        } else {
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert(`Error deleting script: ${error.message}`);
    }
}
</script>
{% endblock %}
